<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Produkt√≥w - Pe≈Çny Audyt</title>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        h1, h2, h3 { color: #333; }
        
        /* --- NAG≈Å√ìWEK I PRZYCISKI --- */
        .header-actions {
            display: flex; flex-direction: column; align-items: flex-start; gap: 15px;
            margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px;
        }
        .header-actions h1 { margin: 0; }
        .header-buttons-container {
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .pdf-btn {
            color: white; border: none; padding: 10px 18px;
            font-size: 13px; font-weight: bold; border-radius: 6px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: background-color 0.2s, transform 0.1s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .pdf-btn:active:not(:disabled) { transform: translateY(2px); }
        .pdf-btn:disabled { opacity: 0.8; cursor: not-allowed; } 
        
        .btn-red { background-color: #dc3545; } .btn-red:hover:not(:disabled) { background-color: #c82333; }
        .btn-green { background-color: #28a745; } .btn-green:hover:not(:disabled) { background-color: #218838; }
        .btn-blue { background-color: #007bff; } .btn-blue:hover:not(:disabled) { background-color: #0056b3; }
        .btn-purple { background-color: #6f42c1; } .btn-purple:hover:not(:disabled) { background-color: #5a32a3; }
        .btn-orange { background-color: #fd7e14; } .btn-orange:hover:not(:disabled) { background-color: #e86e04; }
        .btn-teal { background-color: #20c997; } .btn-teal:hover:not(:disabled) { background-color: #1aa179; }
        .btn-gold { background-color: #ffc107; color: #212529; } .btn-gold:hover:not(:disabled) { background-color: #e0a800; } /* Nowy kolor */

        table.dataTable { background-color: #fff; margin-top: 20px !important; }
        table.dataTable thead th { background-color: #007BFF; color: white; border-bottom: none; }
        .loading { font-size: 1.2em; color: #666; margin-bottom: 20px; }

        /* --- STYLE B≈ÅƒòD√ìW W TABELI --- */
        tr.highlight-brown td { background-color: #f4ece8 !important; color: #5c3a21 !important; } 
        tr.highlight-red-outline td { background-color: #ffe6e6 !important; color: #cc0000 !important; font-weight: bold; } 
        tr.highlight-pink td { background-color: #fce4ec !important; color: #c2185b !important; } 
        tr.highlight-red td { background-color: #ffcccc !important; color: #900 !important; } 
        tr.highlight-orange td { background-color: #ffe5cc !important; color: #b35900 !important; } 
        tr.highlight-grey td { background-color: #e0e0e0 !important; color: #444 !important; } 
        tr.highlight-blue td { background-color: #cce5ff !important; color: #004085 !important; } 
        tr.highlight-cyan td { background-color: #e0f7fa !important; color: #00838f !important; } 
        tr.highlight-yellow td { background-color: #fff3cd !important; color: #856404 !important; } 
        tr.highlight-purple td { background-color: #f3e5f5 !important; color: #7b1fa2 !important; } 
        tr.highlight-indigo td { background-color: #e8eaf6 !important; color: #3f51b5 !important; } 
        tr.highlight-teal td { background-color: #e0f2f1 !important; color: #00796b !important; } 

        /* --- LEGENDA --- */
        .legend-container {
            margin-top: 15px; padding: 15px; background-color: #fff;
            border: 1px solid #ddd; display: inline-block; border-radius: 4px; width: 100%; box-sizing: border-box;
        }
        .legend-item {
            margin-bottom: 6px; padding: 4px 6px; border-radius: 4px;
            cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center;
        }
        .legend-item:hover { background-color: #f0f0f5; }
        .legend-color-box {
            display: inline-block; width: 18px; height: 18px; margin-right: 10px; border: 1px solid #333; flex-shrink: 0;
        }
        .legend-text { font-size: 13px; color: #444; }

        .box-correct { background-color: #fff; border: 2px solid #28a745 !important; }
        .box-brown { background-color: #d7ccc8; border-color: #5d4037; }
        .box-red-outline { background-color: #ffebee; border: 2px solid #d32f2f !important; }
        .box-pink { background-color: #f8bbd0; border-color: #c2185b; }
        .box-red { background-color: #ffcdd2; border-color: #d32f2f; }
        .box-orange { background-color: #ffe0b2; border-color: #e65100; }
        .box-grey { background-color: #e0e0e0; border-color: #616161; }
        .box-blue { background-color: #bbdefb; border-color: #1976d2; }
        .box-cyan { background-color: #b2ebf2; border-color: #00bcd4; } 
        .box-yellow { background-color: #fff9c4; border-color: #fbc02d; }
        .box-purple { background-color: #e1bee7; border-color: #7b1fa2; }
        .box-indigo { background-color: #c5cae9; border-color: #3f51b5; }
        .box-teal { background-color: #b2dfdb; border-color: #00796b; }
        .btn-pink { background-color: #d63384; } .btn-pink:hover:not(:disabled) { background-color: #b02a6c; }
        .box-striped-grey { background: repeating-linear-gradient(45deg, #fff, #fff 4px, #bdbdbd 4px, #bdbdbd 8px); border-color: #757575; }
        .box-striped-green { background: repeating-linear-gradient(45deg, #fff, #fff 4px, #a5d6a7 4px, #a5d6a7 8px); border-color: #388e3c; }

        .dynamic-section {
            margin-top: 20px; padding: 20px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px; min-height: 50px;
        }
        .dynamic-link { font-size: 1.2em; font-weight: bold; color: #007BFF; text-decoration: none; cursor: pointer; border-bottom: 1px dashed #007BFF; }
        .dynamic-link:hover { color: #0056b3; border-bottom: 1px solid #0056b3; }
        #dynamic-container { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }

        /* --- DASHBOARD STATYSTYK --- */
        .detailed-stats-panel { margin-top: 30px; display: flex; flex-direction: column; gap: 20px; }
        .stats-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .stats-section { flex: 1; background: #fff; padding: 15px 20px 20px 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-width: 300px; }
        .stats-section h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: #555; border-bottom: 2px solid #eee; padding-bottom: 10px; text-transform: uppercase; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .stat-box { text-align: center; padding: 15px 10px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-box:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.85em; color: #666; font-weight: bold; }

        .stat-box.total { border-bottom: 4px solid #007BFF; } .stat-box.total .stat-number { color: #007BFF; }
        .stat-box.correct { border-bottom: 4px solid #28a745; background-color: #f2fdf5; } .stat-box.correct .stat-number { color: #28a745; }
        .stat-box.duplicates { border-bottom: 4px solid #6c757d; } .stat-box.duplicates .stat-number { color: #6c757d; }
        .stat-box.dup-sup { border-bottom: 4px solid #388e3c; background-color: #f1f8e9; } .stat-box.dup-sup .stat-number { color: #388e3c; }

        .stat-box.error-brown { border-bottom: 4px solid #5d4037; background-color: #efebe9; } .stat-box.error-brown .stat-number { color: #5d4037; }
        .stat-box.error-red-outline { border-bottom: 4px solid #d32f2f; background-color: #ffebee; } .stat-box.error-red-outline .stat-number { color: #d32f2f; }
        .stat-box.error-pink { border-bottom: 4px solid #c2185b; background-color: #fce4ec; } .stat-box.error-pink .stat-number { color: #c2185b; }

        .stat-box.error-red { border-bottom: 4px solid #dc3545; background-color: #fff5f5; } .stat-box.error-red .stat-number { color: #dc3545; }
        .stat-box.error-orange { border-bottom: 4px solid #fd7e14; background-color: #fff8f2; } .stat-box.error-orange .stat-number { color: #fd7e14; }
        .stat-box.error-grey { border-bottom: 4px solid #495057; background-color: #f8f9fa; } .stat-box.error-grey .stat-number { color: #495057; }

        .stat-box.warning-yellow { border-bottom: 4px solid #ffc107; background-color: #fffdf6; } .stat-box.warning-yellow .stat-number { color: #d39e00; }
        .stat-box.info-blue { border-bottom: 4px solid #17a2b8; background-color: #f4fbfd; } .stat-box.info-blue .stat-number { color: #17a2b8; }
        .stat-box.error-cyan { border-bottom: 4px solid #00bcd4; background-color: #e0f7fa; } .stat-box.error-cyan .stat-number { color: #00838f; } 
        .stat-box.error-purple { border-bottom: 4px solid #7b1fa2; background-color: #f3e5f5; } .stat-box.error-purple .stat-number { color: #7b1fa2; }
        .stat-box.error-indigo { border-bottom: 4px solid #3f51b5; background-color: #e8eaf6; } .stat-box.error-indigo .stat-number { color: #3f51b5; }
        .stat-box.error-teal { border-bottom: 4px solid #00796b; background-color: #e0f2f1; } .stat-box.error-teal .stat-number { color: #00796b; }
    </style>
</head>
<body>

    <div class="header-actions">
        <h1>Baza Produkt√≥w - Audyt Danych</h1>
        <div class="header-buttons-container">
            <button id="dict-btn" class="pdf-btn btn-orange" style="display:none;" onclick="startProcess('dict-btn', 'Generowanie JSON', executeStrictDictionaryFix)">
                üì¶ Uzupe≈Çnij brakujƒÖce Kody Dostawc√≥w wg ID
            </button>
            <button id="adv-supplier-btn" class="pdf-btn btn-purple" style="display:none;" onclick="startProcess('adv-supplier-btn', 'Generowanie JSON', executeAdvancedSupplierFix)">
                ü™™ Uzupe≈Çnij B≈Çƒôdne (Kod = ID) Dostawc√≥w
            </button>
            <button id="multi-ean-btn" class="pdf-btn btn-teal" style="display:none;" onclick="startProcess('multi-ean-btn', 'Filtrowanie EAN', executeFixMultiEans)">
                ‚úÇÔ∏è Wyczy≈õƒá Multi-EAN (Zostaw Poprawne)
            </button>
            <button id="price-btn" class="pdf-btn btn-gold" style="display:none;" onclick="startProcess('price-btn', 'Przeliczanie cen', executeFixMissingPrices)">
                üí∞ Uzupe≈Çnij BrakujƒÖcƒÖ Cenƒô (23% VAT)
            </button>
            <button id="dup-sup-btn" class="pdf-btn btn-pink" style="display:none;" onclick="startProcess('dup-sup-btn', 'Generowanie JSON', executeExportDuplicateSuppliers)">
                üëØ Pobierz Zduplikowanych Dostawc√≥w (JSON)
            </button>
            <button id="fix-btn" class="pdf-btn btn-green" style="display:none;" onclick="startProcess('fix-btn', 'Generowanie JSON', executeExportFixedJSON)">
                üîß Napraw pozosta≈Çe b≈Çƒôdy (Ceny/EAN)
            </button>
            <button id="pdf-btn" class="pdf-btn btn-red" style="display:none;" onclick="startProcess('pdf-btn', 'Tworzenie PDF', executeGeneratePDF)">
                üìÑ Generuj Raport PDF
            </button>
        </div>
    </div>

    <div id="loading" class="loading">Pobieranie i wirtualizacja danych (Odporno≈õƒá na 200 tys. rekord√≥w)...</div>

    <table id="productsTable" class="display" style="width:100%; display:none;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Kod Produktu</th>
                <th>Nazwa Produktu</th>
                <th>Kod Dostawcy</th>
                <th>ID Dostawcy</th>
                <th>Cena Netto</th>
                <th>Cena Brutto</th>
                <th>Kody EAN</th>
            </tr>
        </thead>
    </table>

    <div id="legend" class="legend-container" style="display:none;">
        <p style="margin-top: 0; margin-bottom: 10px; font-weight: bold; color: #555;">Filtry (Kliknij w pozycjƒô, aby podliczyƒá na dole):</p>
        
        <div class="legend-item" onclick="showCategory('correct', 'prawid≈Çowych (brak b≈Çƒôd√≥w)')">
            <span class="legend-color-box box-correct"></span>
            <span class="legend-text">Rekordy <strong>Prawid≈Çowe</strong> (brak b≈Çƒôd√≥w, EAN w normie, kod unikalny, poprawne ceny)</span>
        </div>
        <div class="legend-item" onclick="showCategory('priceZero', 'z b≈Çƒôdem ceny (0 z≈Ç)')">
            <span class="legend-color-box box-brown"></span>
            <span class="legend-text">B≈ÇƒÖd ceny: <strong>Netto lub Brutto wynosi 0 z≈Ç</strong> (lub mniej)</span>
        </div>
        <div class="legend-item" onclick="showCategory('priceCritical', 'z krytycznym b≈Çƒôdem (Netto >= Brutto)')">
            <span class="legend-color-box box-red-outline"></span>
            <span class="legend-text">Krytyczny b≈ÇƒÖd: <strong>Cena Netto jest wiƒôksza lub r√≥wna Brutto</strong></span>
        </div>
        <div class="legend-item" onclick="showCategory('vatError', 'z b≈Çƒôdem oblicze≈Ñ VAT')">
            <span class="legend-color-box box-pink"></span>
            <span class="legend-text">B≈ÇƒÖd VAT: <strong>Cena Brutto nie zgadza siƒô z Netto + 23% VAT</strong></span>
        </div>
        <div class="legend-item" onclick="showCategory('codeLetters', 'gdzie kod zawiera tylko litery')">
            <span class="legend-color-box box-red"></span>
            <span class="legend-text">Kod Produktu zawiera <strong>wy≈ÇƒÖcznie litery</strong></span>
        </div>
        <div class="legend-item" onclick="showCategory('codeOrange', 'gdzie kod ma format: liczby_litery')">
            <span class="legend-color-box box-orange"></span>
            <span class="legend-text">Kod Produktu zawiera <strong>liczby, znak "_" i litery</strong></span>
        </div>
        <div class="legend-item" onclick="showCategory('codeGrey', 'gdzie kod pasuje do heurystyki')">
            <span class="legend-color-box box-grey"></span>
            <span class="legend-text">Kod Produktu pasuje do <strong>heurystyki wzorc√≥w</strong></span>
        </div>
        <div class="legend-item" onclick="showCategory('eanMultiArray', 'posiadajƒÖcych tablicƒô kod√≥w EAN')">
            <span class="legend-color-box box-blue"></span>
            <span class="legend-text">Produkt posiada <strong>wiƒôcej ni≈º jeden kod EAN</strong> (W formacie systemowym/tablicy)</span>
        </div>
        <div class="legend-item" onclick="showCategory('eanMultiStr', 'gdzie wpisano wiele kod√≥w po przecinku')">
            <span class="legend-color-box box-cyan"></span>
            <span class="legend-text">Kod EAN zawiera <strong>wiƒôcej ni≈º jeden w produkcie</strong> (Wpisane rƒôcznie po przecinku)</span>
        </div>
        <div class="legend-item" onclick="showCategory('eanMissing', 'bez kodu EAN')">
            <span class="legend-color-box box-yellow"></span>
            <span class="legend-text">Produkt <strong>nie posiada</strong> kodu EAN (Brak EAN)</span>
        </div>
        <div class="legend-item" onclick="showCategory('eanBadChars', 'z niepo≈ºƒÖdanymi znakami w EAN')">
            <span class="legend-color-box box-purple"></span>
            <span class="legend-text">Kod EAN zawiera <strong>niepo≈ºƒÖdane znaki / separatory</strong> (np. litery, my≈õlniki)</span>
        </div>
        <div class="legend-item" onclick="showCategory('eanInvalid', 'z b≈ÇƒôdnƒÖ sumƒÖ kontrolnƒÖ lub d≈Çugo≈õciƒÖ EAN')">
            <span class="legend-color-box box-indigo"></span>
            <span class="legend-text">Kod EAN ma <strong>z≈ÇƒÖ d≈Çugo≈õƒá</strong> lub <strong>b≈ÇƒôdnƒÖ sumƒô kontrolnƒÖ</strong></span>
        </div>
        <div class="legend-item" onclick="showCategory('missingSupplier', 'bez danych dostawcy')">
            <span class="legend-color-box box-teal"></span>
            <span class="legend-text">Brak <strong>Dostawcy</strong> LUB Kod jest identyczny z ID (Kod = ID)</span>
        </div>
        <div class="legend-item" onclick="showCategory('duplicatesProduct', 'ze zduplikowanym kodem produktu')">
            <span class="legend-color-box box-striped-grey"></span>
            <span class="legend-text">Kody Produktu, kt√≥re <strong>powtarzajƒÖ siƒô</strong> (Duplikaty)</span>
        </div>
        <div class="legend-item" onclick="showCategory('duplicatesSupplier', 'ze zduplikowanym kodem dostawcy')">
            <span class="legend-color-box box-striped-green"></span>
            <span class="legend-text">Kody Dostawcy, kt√≥re <strong>powtarzajƒÖ siƒô</strong> (Ten sam ID i Kod Dostawcy)</span>
        </div>
    </div>

    <div id="dynamic-wrapper" class="dynamic-section" style="display:none;">
        <p id="dynamic-summary-text" style="color: #666; font-style: italic;">Wybierz filtr z legendy powy≈ºej.</p>
        <div id="dynamic-container" style="display: none;">
            <h2 id="dynamic-title">Lista Wybranych Rekord√≥w</h2>
            <table id="dynamicTable" class="display" style="width:100%;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Kod Produktu</th>
                        <th>Nazwa Produktu</th>
                        <th>Kod Dostawcy</th>
                        <th>ID Dostawcy</th>
                        <th>Cena Netto</th>
                        <th>Cena Brutto</th>
                        <th>Kody EAN</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <div id="statistics-panel" class="detailed-stats-panel" style="display:none;">
        <div class="stats-row">
            <div class="stats-section">
                <h3>Og√≥lne Podsumowanie</h3>
                <div class="stat-grid">
                    <div class="stat-box total">
                        <div id="stat-total" class="stat-number">0</div>
                        <div class="stat-label">Wszystkie</div>
                    </div>
                    <div class="stat-box correct">
                        <div id="stat-correct" class="stat-number">0</div>
                        <div class="stat-label">Poprawne</div>
                    </div>
                    <div class="stat-box duplicates">
                        <div id="stat-dup-prod" class="stat-number">0</div>
                        <div class="stat-label">Duplikat Produktu</div>
                    </div>
                    <div class="stat-box dup-sup">
                        <div id="stat-dup-sup" class="stat-number">0</div>
                        <div class="stat-label">Duplikat Dostawcy</div>
                    </div>
                </div>
            </div>

            <div class="stats-section">
                <h3>B≈Çƒôdy Cenowe</h3>
                <div class="stat-grid">
                    <div class="stat-box error-brown">
                        <div id="stat-price-zero" class="stat-number">0</div>
                        <div class="stat-label">Cena 0 z≈Ç</div>
                    </div>
                    <div class="stat-box error-red-outline">
                        <div id="stat-price-crit" class="stat-number">0</div>
                        <div class="stat-label">Netto >= Brutto</div>
                    </div>
                    <div class="stat-box error-pink">
                        <div id="stat-vat" class="stat-number">0</div>
                        <div class="stat-label">B≈ÇƒÖd VAT</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stats-section">
                <h3>B≈Çƒôdy w Kodach Produktu</h3>
                <div class="stat-grid">
                    <div class="stat-box error-red">
                        <div id="stat-code-red" class="stat-number">0</div>
                        <div class="stat-label">Tylko Litery</div>
                    </div>
                    <div class="stat-box error-orange">
                        <div id="stat-code-orange" class="stat-number">0</div>
                        <div class="stat-label">Liczby+Litery</div>
                    </div>
                    <div class="stat-box error-grey">
                        <div id="stat-code-grey" class="stat-number">0</div>
                        <div class="stat-label">Heurystyka</div>
                    </div>
                </div>
            </div>

            <div class="stats-section">
                <h3>EAN i Dostawcy</h3>
                <div class="stat-grid">
                    <div class="stat-box warning-yellow">
                        <div id="stat-ean-missing" class="stat-number">0</div>
                        <div class="stat-label">Brak EAN</div>
                    </div>
                    <div class="stat-box info-blue">
                        <div id="stat-ean-multi-arr" class="stat-number">0</div>
                        <div class="stat-label">EAN: Tablica</div>
                    </div>
                    <div class="stat-box error-cyan">
                        <div id="stat-ean-multi-str" class="stat-number">0</div>
                        <div class="stat-label">Wiƒôcej ni≈º 1</div>
                    </div>
                    <div class="stat-box error-purple">
                        <div id="stat-ean-bad-chars" class="stat-number">0</div>
                        <div class="stat-label">Z≈Çe Znaki</div>
                    </div>
                    <div class="stat-box error-indigo">
                        <div id="stat-ean-invalid" class="stat-number">0</div>
                        <div class="stat-label">Z≈Ça Suma EAN</div>
                    </div>
                    <div class="stat-box error-teal">
                        <div id="stat-sup-missing" class="stat-number">0</div>
                        <div class="stat-label">Brak Dostawcy</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        const categoriesData = {
            correct: [], priceZero: [], priceCritical: [], vatError: [], 
            codeLetters: [], codeOrange: [], codeGrey: [], 
            eanMultiArray: [], eanMultiStr: [], eanMissing: [], eanBadChars: [], eanInvalid: [], 
            missingSupplier: [], duplicatesProduct: [], duplicatesSupplier: []
        };
        
        let totalRecordsCount = 0; 
        let globalRawProducts = []; 
        let globalSupplierStats = {};
        let globalTotalErrors = 0;

        function isValidEAN(ean) {
            const eanString = String(ean).trim();
            if (!/^\d{8}$|^\d{12,14}$/.test(eanString)) return false;
            
            const digits = eanString.slice(0, -1).split('').map(Number);
            const expectedCheckDigit = Number(eanString.slice(-1));
            let sum = 0;
            
            const reversedDigits = [...digits].reverse();
            reversedDigits.forEach((digit, index) => {
                const position = index + 1; 
                if (position % 2 !== 0) sum += digit * 3;
                else sum += digit * 1;
            });
            
            const modulo10 = sum % 10;
            let calculatedCheck = 10 - modulo10;
            if (calculatedCheck === 10) calculatedCheck = 0;
            
            return calculatedCheck === expectedCheckDigit;
        }

        async function fetchProducts() {
            try {
                const response = await fetch('/api/products');
                const products = await response.json();
                
                totalRecordsCount = products.length;
                globalRawProducts = products;

                const onlyLettersRegex = /^[a-zA-ZƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈ºƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª]+$/;
                const numbersUnderscoreLettersRegex = /\d+_[a-zA-ZƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈ºƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª]+/;
                const heuristicRegex = /^[A-Za-z0-9]+[-.\/][A-Za-z0-9]+$/; 

                const productCodeCounts = {};
                const supplierCodeCounts = {};
                
                for (let i = 0; i < products.length; i++) {
                    let p = products[i];
                    let pCode = String(p.product_code || '').trim();
                    let sCode = String(p.supplier_code || '').trim();
                    if (pCode && pCode !== '-') productCodeCounts[pCode] = (productCodeCounts[pCode] || 0) + 1;
                    if (sCode && sCode !== '-' && sCode !== '0' && sCode !== 'BRAK_DANYCH') {
                        supplierCodeCounts[sCode] = (supplierCodeCounts[sCode] || 0) + 1;
                    }
                }

                globalSupplierStats = {};
                globalTotalErrors = 0;
                
                const tableDataForDT = [];

                for (let i = 0; i < products.length; i++) {
                    let product = products[i];
                    let isCorrectRecord = true; 
                    let productErrors = []; 

                    let productCodeValue = String(product.product_code || '').trim();
                    let supplierCode = String(product.supplier_code || '').trim();
                    let supplierId = String(product.supplier_id || '').trim();
                    
                    let netPrice = parseFloat(product.net_price) || 0;
                    let grossPrice = parseFloat(product.gross_price) || 0;

                    let hasMultipleEansArray = false;
                    let hasMultipleEansStr = false;
                    let isEanMissing = false; 
                    let isEanBadChars = false;
                    let isEanInvalid = false;
                    let eanData = product.ean_codes || product.ean; 
                    let eanDisplay = '-'; 
                    
                    let parsedEans = [];
                    if (eanData !== null && eanData !== undefined && eanData !== '') {
                        if (Array.isArray(eanData)) {
                            parsedEans = eanData.map(String);
                            if (parsedEans.length > 1) hasMultipleEansArray = true;
                        } else {
                            let eanStr = String(eanData).trim();
                            if (eanStr.startsWith('[')) {
                                try {
                                    const parsed = JSON.parse(eanStr);
                                    if (Array.isArray(parsed)) {
                                        parsedEans = parsed.map(String);
                                        if (parsedEans.length > 1) hasMultipleEansArray = true;
                                    } else {
                                        parsedEans = [eanStr];
                                    }
                                } catch (e) { parsedEans = [eanStr]; }
                            } else {
                                parsedEans = eanStr.split(',').map(s => s.trim());
                                if (parsedEans.length > 1) hasMultipleEansStr = true; 
                            }
                        }
                    }
                    
                    parsedEans = parsedEans.filter(e => e.trim() !== '');

                    if (parsedEans.length === 0) {
                        isEanMissing = true;
                        eanDisplay = 'Brak EAN';
                    } else {
                        eanDisplay = parsedEans.join(', ');
                        for (let j = 0; j < parsedEans.length; j++) {
                            let eanStr = String(parsedEans[j]).trim();
                            if (/[^\d]/.test(eanStr)) {
                                isEanBadChars = true;
                            } else if (!isValidEAN(eanStr)) {
                                isEanInvalid = true;
                            }
                        }
                    }
                    product.formatted_ean = eanDisplay;

                    let isPriceZero = netPrice <= 0 || grossPrice <= 0;
                    let isPriceCritical = netPrice > 0 && netPrice >= grossPrice;
                    let expectedGross = netPrice * 1.23;
                    let isVatError = netPrice > 0 && Math.abs(grossPrice - expectedGross) > 0.05;

                    let isIdMissing = !supplierId || supplierId === '0' || supplierId === '-';
                    let isCodeMissing = !supplierCode || supplierCode === '0' || supplierCode === '-' || supplierCode === 'BRAK_DANYCH';
                    let isCodeEqualsId = supplierCode === supplierId && !isIdMissing;
                    
                    let isMissingSupplier = isIdMissing || isCodeMissing || isCodeEqualsId;
                    let isSupplierDuplicate = supplierCode && !isCodeMissing && supplierCodeCounts[supplierCode] > 1;
                    let isProductDuplicate = productCodeValue && productCodeValue !== '-' && productCodeCounts[productCodeValue] > 1;

                    if (isPriceZero) { categoriesData.priceZero.push(product); isCorrectRecord = false; productErrors.push("Cena 0 zl"); }
                    if (isPriceCritical) { categoriesData.priceCritical.push(product); isCorrectRecord = false; productErrors.push("Netto >= Brutto"); }
                    if (isVatError) { categoriesData.vatError.push(product); isCorrectRecord = false; productErrors.push("Blad 23% VAT"); }
                    
                    if (isMissingSupplier) { categoriesData.missingSupplier.push(product); isCorrectRecord = false; productErrors.push(isCodeEqualsId ? "Kod Dostawcy = ID" : "Brak dostawcy"); }
                    
                    if (isEanBadChars) { categoriesData.eanBadChars.push(product); isCorrectRecord = false; productErrors.push("Zle znaki EAN"); }
                    if (isEanInvalid) { categoriesData.eanInvalid.push(product); isCorrectRecord = false; productErrors.push("Zla suma/dlugosc EAN"); }
                    
                    if (productCodeValue.length > 0 && onlyLettersRegex.test(productCodeValue)) { categoriesData.codeLetters.push(product); isCorrectRecord = false; productErrors.push("Kod: Tylko litery"); }
                    if (productCodeValue.length > 0 && numbersUnderscoreLettersRegex.test(productCodeValue)) { categoriesData.codeOrange.push(product); isCorrectRecord = false; productErrors.push("Kod: Liczby+Litery"); }
                    if (productCodeValue.length > 0 && heuristicRegex.test(productCodeValue)) { categoriesData.codeGrey.push(product); isCorrectRecord = false; productErrors.push("Kod: Heurystyka"); }
                    
                    if (hasMultipleEansStr) { categoriesData.eanMultiStr.push(product); isCorrectRecord = false; productErrors.push("Wiele EAN (Przecinek)"); } 
                    if (hasMultipleEansArray) { categoriesData.eanMultiArray.push(product); isCorrectRecord = false; productErrors.push("Wiele EAN (Tablica)"); } 
                    if (isEanMissing) { categoriesData.eanMissing.push(product); isCorrectRecord = false; productErrors.push("Brak EAN"); }

                    if (isProductDuplicate) { categoriesData.duplicatesProduct.push(product); isCorrectRecord = false; productErrors.push("Duplikat produktu"); }
                    if (isSupplierDuplicate) { categoriesData.duplicatesSupplier.push(product); isCorrectRecord = false; productErrors.push("Duplikat dostawcy"); }
                    if (productCodeValue.length === 0) { isCorrectRecord = false; productErrors.push("Brak kodu produktu"); }
                    
                    if (isCorrectRecord) { categoriesData.correct.push(product); }

                    let trClass = '';
                    if (isPriceZero) trClass = 'highlight-brown';
                    else if (isPriceCritical) trClass = 'highlight-red-outline';
                    else if (isVatError) trClass = 'highlight-pink';
                    else if (isMissingSupplier) trClass = 'highlight-teal';
                    else if (isEanBadChars) trClass = 'highlight-purple';
                    else if (isEanInvalid) trClass = 'highlight-indigo';
                    else if (productCodeValue.length > 0 && onlyLettersRegex.test(productCodeValue)) trClass = 'highlight-red';
                    else if (productCodeValue.length > 0 && numbersUnderscoreLettersRegex.test(productCodeValue)) trClass = 'highlight-orange';
                    else if (productCodeValue.length > 0 && heuristicRegex.test(productCodeValue)) trClass = 'highlight-grey';
                    else if (hasMultipleEansStr) trClass = 'highlight-cyan';
                    else if (hasMultipleEansArray) trClass = 'highlight-blue';
                    else if (isEanMissing) trClass = 'highlight-yellow';

                    let supplierKey = supplierCode && !isCodeMissing ? supplierCode : (supplierId && !isIdMissing ? supplierId : "BRAK_DANYCH");
                    if (!globalSupplierStats[supplierKey]) {
                        globalSupplierStats[supplierKey] = { totalProducts: 0, totalErrors: 0, errorsByType: {} };
                    }
                    globalSupplierStats[supplierKey].totalProducts++;
                    
                    if (productErrors.length > 0) {
                        globalSupplierStats[supplierKey].totalErrors += productErrors.length;
                        globalTotalErrors += productErrors.length;
                        for (let k = 0; k < productErrors.length; k++) {
                            let err = productErrors[k];
                            globalSupplierStats[supplierKey].errorsByType[err] = (globalSupplierStats[supplierKey].errorsByType[err] || 0) + 1;
                        }
                    }

                    tableDataForDT.push({
                        DT_RowClass: trClass,
                        id: product.product_id,
                        code: productCodeValue || '-',
                        name: product.product_name || '-',
                        sup_code: supplierCode || '-',
                        sup_id: supplierId || '-',
                        net: netPrice.toFixed(2) + ' z≈Ç',
                        gross: grossPrice.toFixed(2) + ' z≈Ç',
                        ean: `<strong>${eanDisplay}</strong>`
                    });
                }

                document.getElementById('stat-total').innerText = products.length;
                document.getElementById('stat-correct').innerText = categoriesData.correct.length;
                document.getElementById('stat-dup-prod').innerText = categoriesData.duplicatesProduct.length;
                document.getElementById('stat-dup-sup').innerText = categoriesData.duplicatesSupplier.length;
                document.getElementById('stat-price-zero').innerText = categoriesData.priceZero.length;
                document.getElementById('stat-price-crit').innerText = categoriesData.priceCritical.length;
                document.getElementById('stat-vat').innerText = categoriesData.vatError.length;
                document.getElementById('stat-code-red').innerText = categoriesData.codeLetters.length;
                document.getElementById('stat-code-orange').innerText = categoriesData.codeOrange.length;
                document.getElementById('stat-code-grey').innerText = categoriesData.codeGrey.length;
                document.getElementById('stat-ean-missing').innerText = categoriesData.eanMissing.length;
                document.getElementById('stat-ean-multi-arr').innerText = categoriesData.eanMultiArray.length;
                document.getElementById('stat-ean-multi-str').innerText = categoriesData.eanMultiStr.length; 
                document.getElementById('stat-ean-bad-chars').innerText = categoriesData.eanBadChars.length;
                document.getElementById('stat-ean-invalid').innerText = categoriesData.eanInvalid.length;
                document.getElementById('stat-sup-missing').innerText = categoriesData.missingSupplier.length;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('productsTable').style.display = 'table';
                document.getElementById('legend').style.display = 'block';
                document.getElementById('dynamic-wrapper').style.display = 'block';
                document.getElementById('statistics-panel').style.display = 'flex'; 
                
                // UAKTYWNIENIE WSZYSTKICH PRZYCISK√ìW W≈ÅƒÑCZNIE Z NOWYM Z≈ÅOTYM
                document.getElementById('dict-btn').style.display = 'inline-flex';
                document.getElementById('adv-supplier-btn').style.display = 'inline-flex';
                document.getElementById('multi-ean-btn').style.display = 'inline-flex';
                document.getElementById('price-btn').style.display = 'inline-flex';
                document.getElementById('dup-sup-btn').style.display = 'inline-flex';
                document.getElementById('fix-btn').style.display = 'inline-flex';
                document.getElementById('pdf-btn').style.display = 'inline-flex';

                $('#productsTable').DataTable({
                    data: tableDataForDT,
                    columns: [
                        { data: 'id' },
                        { data: 'code' },
                        { data: 'name' },
                        { data: 'sup_code' },
                        { data: 'sup_id' },
                        { data: 'net' },
                        { data: 'gross' },
                        { data: 'ean' }
                    ],
                    deferRender: true, 
                    lengthMenu: [10, 25, 50, 100],
                    pageLength: 10,
                    language: { "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pl.json" }
                });

            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                document.getElementById('loading').innerText = 'WystƒÖpi≈Ç b≈ÇƒÖd serwera. Prawdopodobnie skrypt zatrzyma≈Ç siƒô przez uszkodzone dane. Od≈õwie≈º stronƒô (F5).';
            }
        }

        window.showCategory = function(type, reasonText) {
            const data = categoriesData[type];
            const summaryText = document.getElementById('dynamic-summary-text');
            const container = document.getElementById('dynamic-container');

            summaryText.innerHTML = `Znaleziono rekord√≥w ${reasonText}: <a id="dynamic-count-link" class="dynamic-link">${data.length}</a>`;
            container.style.display = 'none';

            const linkElement = document.getElementById('dynamic-count-link');
            const newLinkElement = linkElement.cloneNode(true);
            linkElement.parentNode.replaceChild(newLinkElement, linkElement);

            newLinkElement.addEventListener('click', (e) => {
                e.preventDefault();
                if (container.style.display === 'none' && data.length > 0) {
                    container.style.display = 'block';
                    renderDynamicTable(data);
                } else {
                    container.style.display = 'none';
                }
            });
        };

        function renderDynamicTable(data) {
            if ($.fn.DataTable.isDataTable('#dynamicTable')) {
                $('#dynamicTable').DataTable().destroy();
            }
            
            const dynTableData = data.map(product => {
                let netPrice = parseFloat(product.net_price) || 0;
                let grossPrice = parseFloat(product.gross_price) || 0;
                return {
                    id: product.product_id,
                    code: `<strong>${product.product_code || '-'}</strong>`,
                    name: product.product_name || '-',
                    sup_code: product.supplier_code || '-',
                    sup_id: product.supplier_id || '-',
                    net: netPrice.toFixed(2) + ' z≈Ç',
                    gross: grossPrice.toFixed(2) + ' z≈Ç',
                    ean: `<span style="color: #444; font-weight: bold;">${product.formatted_ean || '-'}</span>`
                };
            });

            $('#dynamicTable').DataTable({
                data: dynTableData,
                columns: [
                    { data: 'id' },
                    { data: 'code' },
                    { data: 'name' },
                    { data: 'sup_code' },
                    { data: 'sup_id' },
                    { data: 'net' },
                    { data: 'gross' },
                    { data: 'ean' }
                ],
                deferRender: true,
                pageLength: 10,
                language: { "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pl.json" }
            });
        }

        function startProcess(btnId, loadingText, actionFunction) {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.innerHTML = `‚è≥ ${loadingText}...`;
            btn.disabled = true;

            setTimeout(() => {
                try {
                    actionFunction();
                    btn.innerHTML = '‚úÖ Zrobione!';
                } catch (err) {
                    console.error("B≈ÇƒÖd podczas operacji: ", err);
                    btn.innerHTML = '‚ùå B≈ÇƒÖd';
                    alert("WystƒÖpi≈Ç b≈ÇƒÖd. Zbyt du≈ºy plik lub brak uprawnie≈Ñ przeglƒÖdarki.");
                } finally {
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2500);
                }
            }, 100);
        }

        // --- Z≈ÅOTY PRZYCISK: UZUPE≈ÅNIANIE BRAKUJƒÑCEJ CENY ---
        function executeFixMissingPrices() {
            const blobParts = ['[\n'];
            let isFirst = true;
            let foundAny = false;

            for (let i = 0; i < globalRawProducts.length; i++) {
                let originalProduct = globalRawProducts[i];
                let rawNet = originalProduct.net_price;
                let rawGross = originalProduct.gross_price;

                let net = parseFloat(rawNet);
                let gross = parseFloat(rawGross);
                
                let isNetValid = !isNaN(net) && net > 0;
                let isGrossValid = !isNaN(gross) && gross > 0;

                // WY≈ÅƒÑCZNIE gdy dok≈Çadnie jedna cena jest pusta/zero, a druga prawid≈Çowa
                let needsNetCalc = (isGrossValid && !isNetValid);
                let needsGrossCalc = (isNetValid && !isGrossValid);

                if (needsNetCalc || needsGrossCalc) {
                    let p = { ...originalProduct }; 
                    p.adnotacje_poprawek = p.adnotacje_poprawek || [];

                    if (needsGrossCalc) {
                        p.gross_price = (net * 1.23).toFixed(2);
                        p.adnotacje_poprawek.push(`Brak ceny Brutto. Wyliczono na podstawie Netto (+23% VAT): ${p.gross_price} z≈Ç.`);
                    } else if (needsNetCalc) {
                        p.net_price = (gross / 1.23).toFixed(2);
                        p.adnotacje_poprawek.push(`Brak ceny Netto. Wyliczono na podstawie Brutto (-23% VAT): ${p.net_price} z≈Ç.`);
                    }

                    delete p.formatted_ean;

                    if (!isFirst) blobParts.push(",\n");
                    blobParts.push(JSON.stringify(p, null, 4));
                    isFirst = false;
                    foundAny = true;
                }
            }
            blobParts.push('\n]');

            if (!foundAny) {
                alert("Brak produkt√≥w wymagajƒÖcych uzupe≈Çnienia pojedynczej ceny (Wszystkie majƒÖ obie, lub brakuje obu).");
                return;
            }

            const blob = new Blob(blobParts, { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "uzupelnione_brakujace_ceny.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- POMARA≈ÉCZOWY PRZYCISK: Formatka s≈Çownika ---
        function executeStrictDictionaryFix() {
            const supplierMap = {};

            for (let i = 0; i < globalRawProducts.length; i++) {
                let p = globalRawProducts[i];
                let sId = String(p.supplier_id || '').trim();
                let sCode = String(p.supplier_code || '').trim();
                
                if (sId && sId !== '0' && sCode && sCode !== '0' && sCode !== 'BRAK_DANYCH' && sCode !== '-' && sCode !== sId) {
                    if (!supplierMap[sId]) supplierMap[sId] = new Set();
                    supplierMap[sId].add(sCode);
                }
            }

            const cleanSupplierMap = {};
            for (const [key, value] of Object.entries(supplierMap)) {
                cleanSupplierMap[key] = Array.from(value).join(', ');
            }

            const blobParts = ['[\n'];
            let isFirst = true;
            let foundAny = false;

            for (let i = 0; i < globalRawProducts.length; i++) {
                let originalProduct = globalRawProducts[i];
                let currentCode = String(originalProduct.supplier_code || '').trim();
                let currentId = String(originalProduct.supplier_id || '').trim();

                if (!currentCode || currentCode === '0' || currentCode === 'BRAK_DANYCH' || currentCode === '-' || currentCode === currentId) {
                    if (currentId && currentId !== '0') {
                        let p = { ...originalProduct }; 
                        
                        if (cleanSupplierMap[currentId]) {
                            p.supplier_code = cleanSupplierMap[currentId];
                            p.adnotacje_poprawek = [`Odnaleziono w s≈Çowniku: Uzupe≈Çniono Kod Dostawcy (${p.supplier_code}) na podstawie przypisanego ID (${currentId}).`];
                            delete p.formatted_ean;
                            
                            if (!isFirst) blobParts.push(",\n");
                            blobParts.push(JSON.stringify(p, null, 4));
                            isFirst = false;
                            foundAny = true;
                        }
                    }
                }
            }
            blobParts.push('\n]');

            if (!foundAny) {
                alert("Nie odnaleziono w bazie produkt√≥w kwalifikujƒÖcych siƒô do naprawy na podstawie s≈Çownika.");
                return;
            }

            const blob = new Blob(blobParts, { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "formatka_uzupelnieni_dostawcy.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- FIOLETOWY PRZYCISK: Uzupe≈Çnianie b≈Çƒôd√≥w KOD = ID (Z do≈ÇƒÖczeniem s≈Çownika) ---
        function executeAdvancedSupplierFix() {
            const supplierMap = {};

            for (let i = 0; i < globalRawProducts.length; i++) {
                let p = globalRawProducts[i];
                let sId = String(p.supplier_id || '').trim();
                let sCode = String(p.supplier_code || '').trim();
                
                if (sId && sId !== '0' && sCode && sCode !== '0' && sCode !== 'BRAK_DANYCH' && sCode !== '-' && sCode !== sId) {
                    if (!supplierMap[sId]) supplierMap[sId] = new Set();
                    supplierMap[sId].add(sCode);
                }
            }

            const cleanSupplierMap = {};
            for (const [key, value] of Object.entries(supplierMap)) {
                cleanSupplierMap[key] = Array.from(value);
            }

            const blobParts = [];
            blobParts.push('{"wszystkie_kody_dostawcy_wg_id":' + JSON.stringify(cleanSupplierMap) + ',"naprawione_rekordy":[');
            let isFirst = true;
            let foundAny = false;

            for (let i = 0; i < globalRawProducts.length; i++) {
                let originalProduct = globalRawProducts[i];
                let currentCode = String(originalProduct.supplier_code || '').trim();
                let currentId = String(originalProduct.supplier_id || '').trim();

                let isMissing = (!currentCode || currentCode === '0' || currentCode === 'BRAK_DANYCH' || currentCode === '-');
                let isCodeEqualsId = (currentCode === currentId && currentId !== '0' && currentId !== '');

                if (isMissing || isCodeEqualsId) {
                    if (currentId && currentId !== '0') {
                        let p = { ...originalProduct }; 
                        let actionMsg = isCodeEqualsId ? "Kod by≈Ç r√≥wny ID." : "Brakowa≈Ço kodu.";
                        
                        if (cleanSupplierMap[currentId]) {
                            p.supplier_code = cleanSupplierMap[currentId].join(', ');
                            p.adnotacje_poprawek = [`${actionMsg} Znaleziono w s≈Çowniku i wpisano: ${p.supplier_code}`];
                        } else {
                            if (isMissing) {
                                p.supplier_code = currentId;
                                p.adnotacje_poprawek = [`${actionMsg} Brak w s≈Çowniku, wstawiono ID (${currentId}) jako kod tymczasowy.`];
                            } else {
                                p.adnotacje_poprawek = [`Kod by≈Ç r√≥wny ID. Niestety nie znaleziono w≈Ça≈õciwego kodu w bazie.`];
                            }
                        }
                        
                        delete p.formatted_ean;
                        if (!isFirst) blobParts.push(",");
                        blobParts.push(JSON.stringify(p));
                        isFirst = false;
                        foundAny = true;
                    }
                }
            }
            blobParts.push(']}');

            if (!foundAny) alert("Brak produkt√≥w do naprawy.");

            const blob = new Blob(blobParts, { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "zaawansowana_naprawa_dostawcow.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- MORSKI PRZYCISK: CZYSZCZENIE MULTI EAN ---
        function executeFixMultiEans() {
            const blobParts = ["[\n"];
            let isFirst = true;
            let foundAny = false;

            for (let i = 0; i < globalRawProducts.length; i++) {
                let originalProduct = globalRawProducts[i];
                let eanData = originalProduct.ean_codes || originalProduct.ean; 
                
                let parsedEans = [];
                if (eanData !== null && eanData !== undefined && eanData !== '') {
                    if (Array.isArray(eanData)) {
                        parsedEans = eanData.map(String);
                    } else {
                        let eanStr = String(eanData).trim();
                        if (eanStr.startsWith('[')) {
                            try {
                                const parsed = JSON.parse(eanStr);
                                if (Array.isArray(parsed)) parsedEans = parsed.map(String);
                                else parsedEans = [eanStr];
                            } catch (e) { parsedEans = [eanStr]; }
                        } else {
                            parsedEans = eanStr.split(',').map(s => s.trim());
                        }
                    }
                }
                parsedEans = parsedEans.filter(e => e.trim() !== '');

                if (parsedEans.length > 1) {
                    let validEans = [];
                    let hasInvalid = false;

                    parsedEans.forEach(eanStr => {
                        let cleaned = eanStr.replace(/[^\d]/g, ''); 
                        if (cleaned !== eanStr || !isValidEAN(cleaned)) {
                            hasInvalid = true;
                        } else {
                            validEans.push(cleaned);
                        }
                    });

                    let p = { ...originalProduct };
                    p.adnotacje_poprawek = [];
                    
                    if (hasInvalid) {
                        if (validEans.length > 0) {
                            p.adnotacje_poprawek.push(`Usuniƒôto b≈Çƒôdne kody z listy. Pozostawiono poprawne: ${validEans.length} szt.`);
                        } else {
                            p.adnotacje_poprawek.push(`Wszystkie podane kody EAN by≈Çy b≈Çƒôdne. Usuniƒôto je ca≈Çkowicie.`);
                        }
                    } else {
                        p.adnotacje_poprawek.push(`Wszystkie wpisane kody EAN (${validEans.length} szt.) sƒÖ prawid≈Çowe. Zachowano wszystkie.`);
                    }

                    p.ean_codes = validEans.join(', ');
                    delete p.formatted_ean;

                    if (!isFirst) blobParts.push(",\n");
                    blobParts.push(JSON.stringify(p, null, 4));
                    isFirst = false;
                    foundAny = true;
                }
            }
            blobParts.push("\n]");

            if (!foundAny) {
                alert("Brak produkt√≥w z wieloma kodami EAN do przeanalizowania.");
                return;
            }

            const blob = new Blob(blobParts, { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "wyczyszczone_multi_eany.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        // --- R√ì≈ªOWY PRZYCISK: EKSPORT ZDUPLIKOWANYCH KOD√ìW DOSTAWC√ìW ---
        function executeExportDuplicateSuppliers() {
            const supplierCodeCounts = {};
            
            // 1. Zliczanie wystƒÖpie≈Ñ kod√≥w dostawcy w ca≈Çej bazie
            for (let i = 0; i < globalRawProducts.length; i++) {
                let p = globalRawProducts[i];
                let sCode = String(p.supplier_code || '').trim();
                // Ignorujemy puste pola, zera i my≈õlniki
                if (sCode && sCode !== '-' && sCode !== '0' && sCode !== 'BRAK_DANYCH') {
                    supplierCodeCounts[sCode] = (supplierCodeCounts[sCode] || 0) + 1;
                }
            }

            // 2. Grupowanie zduplikowanych rekord√≥w wg Kodu Dostawcy
            const duplicatesGrouped = {};
            let foundAny = false;

            for (let i = 0; i < globalRawProducts.length; i++) {
                let p = globalRawProducts[i];
                let sCode = String(p.supplier_code || '').trim();
                let sId = String(p.supplier_id || '').trim();

                // Je≈õli kod wystƒôpuje wiƒôcej ni≈º 1 raz, dodajemy go do obiektu
                if (sCode && sCode !== '-' && sCode !== '0' && sCode !== 'BRAK_DANYCH' && supplierCodeCounts[sCode] > 1) {
                    if (!duplicatesGrouped[sCode]) {
                        duplicatesGrouped[sCode] = [];
                    }
                    // Zapisujemy tylko niezbƒôdne dane dla przejrzysto≈õci pliku
                    duplicatesGrouped[sCode].push({
                        "id_produktu": p.product_id,
                        "kod_produktu": p.product_code,
                        "id_dostawcy": sId,
                        "kod_dostawcy": sCode
                    });
                    foundAny = true;
                }
            }

            if (!foundAny) {
                alert("Brak zduplikowanych kod√≥w dostawc√≥w w bazie.");
                return;
            }

            // 3. Konwersja i pobieranie bezpiecznego pliku
            const jsonString = JSON.stringify(duplicatesGrouped, null, 4);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "zduplikowani_dostawcy.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        // --- ZIELONY ZWYK≈ÅY (EAN/CENY) ---
        function executeExportFixedJSON() {
            const blobParts = ["[\n"];
            let isFirst = true;
            let foundAny = false;

            for (let i = 0; i < globalRawProducts.length; i++) {
                let originalProduct = globalRawProducts[i];
                let eanData = originalProduct.ean_codes || originalProduct.ean; 
                let net = parseFloat(originalProduct.net_price) || 0;
                let gross = parseFloat(originalProduct.gross_price) || 0;
                let needsFixing = false;

                if (!eanData || String(eanData) === '' || String(eanData) === '[]') needsFixing = true;
                if (!needsFixing && net <= 0 && gross <= 0) needsFixing = true;
                if (!needsFixing && net > 0 && Math.abs(gross - (net * 1.23)) > 0.05) needsFixing = true;
                if (!needsFixing && net > 0 && net >= gross) needsFixing = true;
                
                if (!needsFixing && eanData) {
                    let eanStr = String(eanData);
                    if (/[^\d,\[\]\s"]/.test(eanStr) || eanStr.split(',').length > 1) needsFixing = true;
                }

                if (needsFixing) {
                    let p = { ...originalProduct }; 
                    let repairLog = [];
                    let modified = false;

                    let pEanData = p.ean_codes || p.ean; 
                    let parsedEans = [];
                    if (pEanData !== null && pEanData !== undefined && pEanData !== '') {
                        if (Array.isArray(pEanData)) {
                            parsedEans = pEanData.map(String);
                        } else {
                            let eanStr = String(pEanData).trim();
                            if (eanStr.startsWith('[')) {
                                try {
                                    const parsed = JSON.parse(eanStr);
                                    if (Array.isArray(parsed)) parsedEans = parsed.map(String);
                                    else parsedEans = [eanStr];
                                } catch (e) { parsedEans = [eanStr]; }
                            } else {
                                parsedEans = eanStr.split(',').map(s => s.trim());
                            }
                        }
                    }
                    parsedEans = parsedEans.filter(e => e.trim() !== '');

                    let validEans = [];
                    let hasBadChars = false;
                    parsedEans.forEach(eanStr => {
                        let cleaned = eanStr.replace(/[^\d]/g, ''); 
                        if (cleaned !== eanStr) hasBadChars = true;
                        if (isValidEAN(cleaned)) validEans.push(cleaned);
                    });

                    if (parsedEans.length === 0) {
                        modified = true; repairLog.push("Brak kodu EAN (Wymaga recznej weryfikacji)");
                    } else if (parsedEans.length > 1 || hasBadChars || validEans.length < parsedEans.length) {
                        modified = true;
                        if (validEans.length > 0) {
                            p.ean_codes = [validEans[0]]; 
                            if (parsedEans.length > 1) repairLog.push("Usunieto nadmiarowe EAN");
                            if (hasBadChars) repairLog.push("Usunieto zle znaki z EAN");
                        } else {
                            repairLog.push("EAN nie do naprawienia (zla suma/dlugosc)");
                        }
                    }

                    let expectedGross = net * 1.23;
                    if (net <= 0 && gross <= 0) {
                        modified = true; repairLog.push("Ceny zerowe");
                    } else if (net > 0 && Math.abs(gross - expectedGross) > 0.05) {
                        modified = true; p.gross_price = expectedGross.toFixed(2); repairLog.push("Przeliczono VAT na Brutto");
                    } else if (net > 0 && net >= gross) {
                        modified = true; p.gross_price = expectedGross.toFixed(2); repairLog.push("Cena Netto wyzsza od Brutto - Naprawiono");
                    }

                    if (modified) {
                        p.adnotacje_poprawek = repairLog; 
                        delete p.formatted_ean; 

                        if (!isFirst) blobParts.push(",\n");
                        blobParts.push(JSON.stringify(p, null, 4));
                        isFirst = false;
                        foundAny = true;
                    }
                }
            }
            blobParts.push("\n]");

            if (!foundAny) {
                alert("Super! Skrypt nie znalaz≈Ç ≈ºadnych b≈Çƒôd√≥w matematycznych do naprawy.");
                return;
            }

            const blob = new Blob(blobParts, { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "naprawione_bledy_matematyczne.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- CZERWONY PRZYCISK: GENERATOR PDF ---
        function executeGeneratePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const removePl = (str) => {
                const map = { 'ƒÖ':'a', 'ƒá':'c', 'ƒô':'e', '≈Ç':'l', '≈Ñ':'n', '√≥':'o', '≈õ':'s', '≈∫':'z', '≈º':'z', 'ƒÑ':'A', 'ƒÜ':'C', 'ƒò':'E', '≈Å':'L', '≈É':'N', '√ì':'O', '≈ö':'S', '≈π':'Z', '≈ª':'Z' };
                return str.replace(/[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈ºƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª]/g, match => map[match]);
            };

            doc.setFontSize(20);
            doc.text(removePl("Raport z Audytu Bazy Produktow"), 14, 20);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(removePl(`Data wygenerowania: ${new Date().toLocaleString('pl-PL')}`), 14, 28);
            
            const statsData = [
                ['Ogolne', 'Wszystkie produkty', totalRecordsCount],
                ['Ogolne', 'Calkowicie poprawne rekordy', categoriesData.correct.length],
                ['Duplikaty', 'Zduplikowane kody produktu', categoriesData.duplicatesProduct.length],
                ['Duplikaty', 'Zduplikowane kody dostawcy', categoriesData.duplicatesSupplier.length],
                ['Bledy Cenowe', 'Cena Netto lub Brutto wynosi 0 zl', categoriesData.priceZero.length],
                ['Bledy Cenowe', 'Krytyczny blad (Netto >= Brutto)', categoriesData.priceCritical.length],
                ['Bledy Cenowe', 'Blad wyliczenia 23% VAT', categoriesData.vatError.length],
                ['Bledy Kodow', 'Kod produktu ma tylko litery', categoriesData.codeLetters.length],
                ['Bledy Kodow', 'Kod to liczby, znak _ i litery', categoriesData.codeOrange.length],
                ['Bledy Kodow', 'Kod pasuje do heurystyki (np. . - /)', categoriesData.codeGrey.length],
                ['EAN i Dostawcy', 'Calkowity brak kodu EAN', categoriesData.eanMissing.length],
                ['EAN i Dostawcy', 'Produkt ma wiele kodow EAN (Tablica)', categoriesData.eanMultiArray.length],
                ['EAN i Dostawcy', 'Wiele kodow EAN wpisanych recznie', categoriesData.eanMultiStr.length], 
                ['EAN i Dostawcy', 'Kod zawiera niepozadane znaki lub litery', categoriesData.eanBadChars.length], 
                ['EAN i Dostawcy', 'Bledna suma kontrolna lub dlugosc', categoriesData.eanInvalid.length], 
                ['EAN i Dostawcy', 'Brak przypisanego Dostawcy (lub Kod=ID)', categoriesData.missingSupplier.length],
            ];

            doc.autoTable({
                startY: 38,
                head: [[removePl('Kategoria'), removePl('Rodzaj Bledu / Statystyki'), removePl('Liczba Rekordow')]],
                body: statsData.map(row => [removePl(row[0]), removePl(row[1]), row[2]]),
                theme: 'striped',
                headStyles: { fillColor: [220, 53, 69] },
                styles: { font: 'helvetica', fontSize: 10 },
                columnStyles: { 2: { halign: 'center', fontStyle: 'bold' } }
            });

            doc.addPage("a4", "landscape");
            doc.setFontSize(16);
            doc.setTextColor(50);
            doc.text(removePl("Szczegolowe Statystyki na Dostawce"), 14, 20);

            const supplierTableData = Object.keys(globalSupplierStats).map(key => {
                const stat = globalSupplierStats[key];
                const errorsPer100 = stat.totalProducts > 0 ? ((stat.totalErrors / stat.totalProducts) * 100).toFixed(2) : 0;
                const shareOfErrors = globalTotalErrors > 0 ? ((stat.totalErrors / globalTotalErrors) * 100).toFixed(2) + '%' : '0%';
                
                const top5 = Object.entries(stat.errorsByType)
                                   .sort((a, b) => b[1] - a[1])
                                   .slice(0, 5)
                                   .map(e => `${removePl(e[0])} (${e[1]})`)
                                   .join('\n');
                                   
                return [
                    removePl(key),
                    stat.totalProducts,
                    stat.totalErrors,
                    errorsPer100,
                    shareOfErrors,
                    top5
                ];
            });

            supplierTableData.sort((a, b) => b[2] - a[2]);
            const filteredSupplierData = supplierTableData.filter(row => row[2] > 0);

            doc.autoTable({
                startY: 28,
                head: [[
                    removePl('Kod Dostawcy / ID'), 
                    removePl('Liczba Towarow'), 
                    removePl('Liczba Bledow'), 
                    removePl('Wskaznik (Bledy/100 tow.)'), 
                    removePl('% Udzial w Bledach'), 
                    removePl('TOP 5 Najczestszych Bledow')
                ]],
                body: filteredSupplierData,
                theme: 'grid',
                headStyles: { fillColor: [0, 123, 255] }, 
                styles: { font: 'helvetica', fontSize: 9 },
                columnStyles: {
                    0: { cellWidth: 35, fontStyle: 'bold' },
                    1: { halign: 'center', cellWidth: 25 },
                    2: { halign: 'center', cellWidth: 25, fontStyle: 'bold', textColor: [220, 53, 69] },
                    3: { halign: 'center', cellWidth: 35 },
                    4: { halign: 'center', cellWidth: 35 },
                    5: { cellWidth: 'auto' }
                }
            });

            doc.save('Raport_Audytu_Bazy_Danych.pdf');
        }

        fetchProducts();
    </script>
</body>
</html>